# –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å –∞–≥–µ–Ω—Ç–æ–º

## –û–ø–∏—Å–∞–Ω–∏–µ

–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞ —Å MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º –Ø–Ω–¥–µ–∫—Å –¢—Ä–µ–∫–µ—Ä–∞. –ê–≥–µ–Ω—Ç –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ MCP –ø—Ä–æ—Ç–æ–∫–æ–ª –∏ –ø–æ–ª—É—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

1. **MCP –°–µ—Ä–≤–µ—Ä** (`server/src/main/kotlin/org/example/demo/McpServer.kt`)
   - –†–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç `yandex_tracker`
   - –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ JSON-RPC 2.0
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ MCP

2. **MCP –ö–ª–∏–µ–Ω—Ç** (`composeApp/src/commonMain/kotlin/org/example/demo/chat/McpClient.kt`)
   - –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ MCP —Å–µ—Ä–≤–µ—Ä—É
   - –í—ã–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ `callTool()`
   - –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

3. **ChatViewModel** (`composeApp/src/commonMain/kotlin/org/example/demo/chat/ChatViewModel.kt`)
   - –ò–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Å –∞–≥–µ–Ω—Ç–æ–º
   - –ú–µ—Ç–æ–¥—ã: `callMcpTool()`, `getMcpTools()`

## –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ø–Ω–¥–µ–∫—Å –¢—Ä–µ–∫–µ—Ä–∞

### –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:

1. **`count_open_tasks`** - –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞–¥–∞—á
   ```json
   {
     "action": "count_open_tasks",
     "queue": "TEST"
   }
   ```

2. **`get_open_tasks`** - –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞–¥–∞—á
   ```json
   {
     "action": "get_open_tasks",
     "queue": "TEST"
   }
   ```

3. **`get_task`** - –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–¥–∞—á–µ
   ```json
   {
     "action": "get_task",
     "task_id": "TEST-1",
     "queue": "TEST"
   }
   ```

## –ó–∞–ø—É—Å–∫ –ø—Ä–∏–º–µ—Ä–∞

### 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ MCP —Å–µ—Ä–≤–µ—Ä

```bash
./gradlew :server:run
```

–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `http://localhost:8080/mcp`

### 2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–º–µ—Ä –∞–≥–µ–Ω—Ç–∞

–í IntelliJ IDEA:
- –û—Ç–∫—Ä–æ–π—Ç–µ `composeApp/src/jvmMain/kotlin/org/example/demo/McpAgentExample.kt`
- –ü–ö–ú –Ω–∞ `main()` ‚Üí Run 'McpAgentExampleKt.main()'

–ò–ª–∏ —á–µ—Ä–µ–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª:
```bash
./gradlew :composeApp:run --args="mcp-agent"
```

## –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü—Ä–æ–≥—Ä–∞–º–º–Ω—ã–π –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:

```kotlin
val httpClient = createHttpClient()
val mcpClient = McpClient(httpClient, "http://localhost:8080/mcp")

// –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è
mcpClient.connect()

// –í—ã–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞–¥–∞—á
val result = mcpClient.callTool(
    name = "yandex_tracker",
    arguments = buildJsonObject {
        put("action", "count_open_tasks")
        put("queue", "TEST")
    }
)

// –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
val count = result?.content?.firstOrNull()?.text
println("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞–¥–∞—á: $count")
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–≥–µ–Ω—Ç–æ–º –≤ ChatViewModel:

```kotlin
// –í –º–µ—Ç–æ–¥–µ sendMessage() –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É:
// 1. –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// 2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –Ω—É–∂–µ–Ω –ª–∏ –≤—ã–∑–æ–≤ MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
// 3. –í—ã–∑–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —á–µ—Ä–µ–∑ callMcpTool()
// 4. –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è AI
// 5. –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ AI —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞

viewModelScope.launch {
    // –ü—Ä–∏–º–µ—Ä: –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –∑–∞–¥–∞—á–∞—Ö
    if (text.contains("–∑–∞–¥–∞—á", ignoreCase = true) || 
        text.contains("—Ç—Ä–µ–∫–µ—Ä", ignoreCase = true)) {
        
        // –í—ã–∑—ã–≤–∞–µ–º MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
        val toolResult = callMcpTool(
            serverName = "local-server",
            toolName = "yandex_tracker",
            arguments = buildJsonObject {
                put("action", "count_open_tasks")
            }
        )
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç
        if (toolResult != null) {
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–∫ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –≤ –ø—Ä–æ–º–ø—Ç
        }
    }
}
```

## –ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞

1. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å**: "–°–∫–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞–¥–∞—á –≤ –Ø–Ω–¥–µ–∫—Å –¢—Ä–µ–∫–µ—Ä–µ?"

2. **–ê–≥–µ–Ω—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å** –∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —á—Ç–æ –Ω—É–∂–µ–Ω –≤—ã–∑–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞

3. **–ê–≥–µ–Ω—Ç –≤—ã–∑—ã–≤–∞–µ—Ç MCP –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç**:
   ```kotlin
   val result = mcpClient.callTool("yandex_tracker", arguments)
   ```

4. **MCP —Å–µ—Ä–≤–µ—Ä –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å** –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
   ```
   "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥–∏ 'TEST': 5"
   ```

5. **–ê–≥–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç** –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:
   ```
   "–°–æ–≥–ª–∞—Å–Ω–æ –¥–∞–Ω–Ω—ã–º –Ø–Ω–¥–µ–∫—Å –¢—Ä–µ–∫–µ—Ä–∞, –≤ –æ—á–µ—Ä–µ–¥–∏ TEST –æ—Ç–∫—Ä—ã—Ç–æ 5 –∑–∞–¥–∞—á."
   ```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ß–µ—Ä–µ–∑ curl:

```bash
# 1. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
curl -X POST http://localhost:8080/mcp \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/list"
  }'

# 2. –í—ã–∑–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∑–∞–¥–∞—á
curl -X POST http://localhost:8080/mcp \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 2,
    "method": "tools/call",
    "params": {
      "name": "yandex_tracker",
      "arguments": {
        "action": "count_open_tasks",
        "queue": "TEST"
      }
    }
  }'

# 3. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞–¥–∞—á
curl -X POST http://localhost:8080/mcp \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 3,
    "method": "tools/call",
    "params": {
      "name": "yandex_tracker",
      "arguments": {
        "action": "get_open_tasks",
        "queue": "TEST"
      }
    }
  }'
```

### –ß–µ—Ä–µ–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:

–ó–∞–ø—É—Å—Ç–∏—Ç–µ `McpAgentExample.kt` - –æ–Ω –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞ —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º.

## –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ –Ø–Ω–¥–µ–∫—Å –¢—Ä–µ–∫–µ—Ä:

1. –û–±–Ω–æ–≤–∏—Ç–µ `handleToolCall()` –≤ `McpServer.kt`:
```kotlin
"yandex_tracker" -> {
    when (action) {
        "create_task" -> {
            // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
        }
        "update_task" -> {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
        }
        // ... –¥—Ä—É–≥–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
    }
}
```

2. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ö–µ–º—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –≤ `handleToolsList()`:
```kotlin
putJsonObject("action") {
    putJsonArray("enum") {
        add("get_open_tasks")
        add("count_open_tasks")
        add("get_task")
        add("create_task")  // –ù–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
        add("update_task")  // –ù–æ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ
    }
}
```

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ä–µ–∞–ª—å–Ω–æ–º—É API –Ø–Ω–¥–µ–∫—Å –¢—Ä–µ–∫–µ—Ä–∞:

–ó–∞–º–µ–Ω–∏—Ç–µ –º–æ–∫ –¥–∞–Ω–Ω—ã–µ –≤ `getOpenTasks()`, `countOpenTasks()`, `getTaskById()` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ API –Ø–Ω–¥–µ–∫—Å –¢—Ä–µ–∫–µ—Ä–∞.

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ—Ä–∞ –≤—ã —É–≤–∏–¥–∏—Ç–µ:

```
=== –ü–†–ò–ú–ï–†: –ê–ì–ï–ù–¢ –° MCP –ò–ù–°–¢–†–£–ú–ï–ù–¢–û–ú –Ø–ù–î–ï–ö–° –¢–†–ï–ö–ï–†–ê ===

1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ª–æ–∫–∞–ª—å–Ω–æ–º—É MCP —Å–µ—Ä–≤–µ—Ä—É...
   ‚úì –£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ MCP —Å–µ—Ä–≤–µ—Ä—É

2. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤...
   –ù–∞–π–¥–µ–Ω–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤: 4
   - echo: Echoes back the input text
   - get_current_time: Returns the current server time
   - calculate: Performs basic arithmetic operations
   - yandex_tracker: –†–∞–±–æ—Ç–∞ —Å –∑–∞–¥–∞—á–∞–º–∏ –Ø–Ω–¥–µ–∫—Å –¢—Ä–µ–∫–µ—Ä–∞...

3. –ê–≥–µ–Ω—Ç –≤—ã–∑—ã–≤–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç yandex_tracker...
   ‚úì –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:
   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞–¥–∞—á –≤ –æ—á–µ—Ä–µ–¥–∏ 'TEST': 5

4. –ê–≥–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞–¥–∞—á...
   ‚úì –°–ø–∏—Å–æ–∫ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∑–∞–¥–∞—á:
   –û—Ç–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥–∏ 'TEST':
   - TEST-1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –±–∞–≥ –≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
   - TEST-2: –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∏—Å–∫–∞
   ...
```

–ê–≥–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –≤—ã–∑–≤–∞–ª –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏ –ø–æ–ª—É—á–∏–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç! üéâ

